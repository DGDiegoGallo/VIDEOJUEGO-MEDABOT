<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Barrel Collision Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #2c3e50;
            color: white;
            font-family: Arial, sans-serif;
        }
        #game-container {
            border: 2px solid #34495e;
            margin: 20px auto;
            display: block;
        }
        .info {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        .controls {
            background: #34495e;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .status {
            background: #27ae60;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .log {
            background: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="info">
        <h1>üß™ Test: Barrel vs Structure Collision Fix</h1>
        <p>Prueba que los barriles no se procesen como estructuras normales</p>
        
        <div class="controls">
            <h3>Elementos:</h3>
            <p><strong>üîµ Azul:</strong> Jugador</p>
            <p><strong>üõ¢Ô∏è Marr√≥n:</strong> Barriles explosivos (deben explotar)</p>
            <p><strong>üü´ Gris:</strong> Estructuras normales (deben romperse sin explotar)</p>
            <p><strong>üü° Amarillo:</strong> Balas autom√°ticas</p>
        </div>

        <div class="status">
            <p><strong>Barriles:</strong> <span id="barrels">0</span> | <strong>Estructuras:</strong> <span id="structures">0</span> | <strong>Explosiones:</strong> <span id="explosions">0</span></p>
        </div>

        <div class="log" id="log">
            <div>üîç Log de eventos:</div>
        </div>
    </div>

    <div id="game-container"></div>

    <script>
        // Variables globales
        let player, cursors;
        let bullets = [];
        let barrels = [];
        let structures = [];
        let explosionCount = 0;
        let shootTimer = 0;

        // Configuraci√≥n del juego
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#1a252f',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        function preload() {
            // No necesitamos cargar assets externos
        }

        function create() {
            // Crear jugador
            player = this.add.rectangle(400, 300, 20, 20, 0x3498db);
            this.physics.add.existing(player);
            player.body.setCollideWorldBounds(true);

            // Crear controles
            cursors = this.input.keyboard.createCursorKeys();

            // Crear elementos de prueba
            createTestElements.call(this);

            // Actualizar UI
            updateStatus();
            logEvent('üéÆ Sistema iniciado');
        }

        function createTestElements() {
            // Crear barriles explosivos
            const barrelPositions = [
                { x: 200, y: 200, label: 'Barril 1' },
                { x: 600, y: 200, label: 'Barril 2' },
                { x: 400, y: 150, label: 'Barril 3' }
            ];

            barrelPositions.forEach(pos => {
                const barrel = createBarrel.call(this, pos.x, pos.y, pos.label);
                barrels.push(barrel);
            });

            // Crear estructuras normales
            const structurePositions = [
                { x: 300, y: 400, label: 'Estructura 1' },
                { x: 500, y: 450, label: 'Estructura 2' },
                { x: 400, y: 500, label: 'Estructura 3' }
            ];

            structurePositions.forEach(pos => {
                const structure = createStructure.call(this, pos.x, pos.y, pos.label);
                structures.push(structure);
            });

            logEvent(`üèóÔ∏è Creados ${barrels.length} barriles y ${structures.length} estructuras`);
        }

        function createBarrel(x, y, label) {
            // Crear barril visual
            const barrel = this.add.rectangle(x, y, 24, 24, 0x8b4513);
            barrel.setStrokeStyle(3, 0x654321);
            
            // Agregar f√≠sica
            this.physics.add.existing(barrel, true);
            
            // Propiedades del barril
            barrel.health = 1;
            barrel.maxHealth = 1;
            barrel.isDestructible = true;
            barrel.type = 'explosive_barrel';
            barrel.label = label;

            // Elementos visuales
            const warning = this.add.triangle(x, y - 2, 0, -8, -7, 6, 7, 6, 0xffff00);
            warning.setStrokeStyle(1, 0xff8800);
            
            const tntText = this.add.text(x, y + 4, 'TNT', {
                fontSize: '8px',
                color: '#ff0000',
                fontStyle: 'bold'
            }).setOrigin(0.5);

            // Efecto de parpadeo
            this.tweens.add({
                targets: [warning, tntText],
                alpha: 0.6,
                duration: 1000,
                yoyo: true,
                repeat: -1
            });

            barrel.additionalElements = [warning, tntText];
            return barrel;
        }

        function createStructure(x, y, label) {
            // Crear estructura normal
            const structure = this.add.rectangle(x, y, 30, 30, 0x7f8c8d);
            structure.setStrokeStyle(2, 0x34495e);
            
            // Agregar f√≠sica
            this.physics.add.existing(structure, true);
            
            // Propiedades de la estructura
            structure.health = 2;
            structure.maxHealth = 2;
            structure.isDestructible = true;
            structure.type = 'normal_structure';
            structure.label = label;

            return structure;
        }

        function update(time, delta) {
            // Mover jugador
            if (cursors.left.isDown) {
                player.body.setVelocityX(-200);
            } else if (cursors.right.isDown) {
                player.body.setVelocityX(200);
            } else {
                player.body.setVelocityX(0);
            }

            if (cursors.up.isDown) {
                player.body.setVelocityY(-200);
            } else if (cursors.down.isDown) {
                player.body.setVelocityY(200);
            } else {
                player.body.setVelocityY(0);
            }

            // Disparo autom√°tico
            shootTimer += delta;
            if (shootTimer >= 400) {
                shootTimer = 0;
                autoShoot.call(this);
            }

            // Actualizar balas
            updateBullets.call(this);

            // Verificar colisiones
            checkCollisions.call(this);
        }

        function autoShoot() {
            const allTargets = [...barrels, ...structures];
            if (allTargets.length === 0) return;

            // Encontrar objetivo m√°s cercano
            let closestTarget = null;
            let closestDistance = Infinity;

            allTargets.forEach(target => {
                const distance = Phaser.Math.Distance.Between(
                    player.x, player.y, target.x, target.y
                );
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestTarget = target;
                }
            });

            if (closestTarget) {
                shootBullet.call(this, player.x, player.y, closestTarget.x, closestTarget.y);
            }
        }

        function shootBullet(fromX, fromY, toX, toY) {
            const bullet = this.add.rectangle(fromX, fromY, 6, 6, 0xf1c40f);
            this.physics.add.existing(bullet);

            const angle = Phaser.Math.Angle.Between(fromX, fromY, toX, toY);
            const speed = 400;

            bullet.body.setVelocity(
                Math.cos(angle) * speed,
                Math.sin(angle) * speed
            );

            bullets.push(bullet);
        }

        function updateBullets() {
            bullets = bullets.filter(bullet => {
                if (bullet.x < -50 || bullet.x > 850 || bullet.y < -50 || bullet.y > 650) {
                    bullet.destroy();
                    return false;
                }
                return true;
            });
        }

        function checkCollisions() {
            // PASO 1: Verificar colisiones con barriles PRIMERO
            bullets.forEach((bullet, bulletIndex) => {
                barrels.forEach((barrel, barrelIndex) => {
                    if (Phaser.Math.Distance.Between(bullet.x, bullet.y, barrel.x, barrel.y) < 20) {
                        logEvent(`üí• BARRIL: Bala golpea ${barrel.label} - DEBE EXPLOTAR`);
                        
                        // Remover bala
                        bullet.destroy();
                        bullets.splice(bulletIndex, 1);

                        // Explotar barril
                        explodeBarrel.call(this, barrel, barrelIndex);
                        return; // Salir del loop
                    }
                });
            });

            // PASO 2: Verificar colisiones con estructuras normales DESPU√âS
            bullets.forEach((bullet, bulletIndex) => {
                structures.forEach((structure, structureIndex) => {
                    if (Phaser.Math.Distance.Between(bullet.x, bullet.y, structure.x, structure.y) < 20) {
                        logEvent(`üéØ ESTRUCTURA: Bala golpea ${structure.label} - debe romperse sin explotar`);
                        
                        // Remover bala
                        bullet.destroy();
                        bullets.splice(bulletIndex, 1);

                        // Da√±ar estructura
                        damageStructure.call(this, structure, structureIndex);
                        return; // Salir del loop
                    }
                });
            });
        }

        function explodeBarrel(barrel, barrelIndex) {
            logEvent(`üí• EXPLOSI√ìN: ${barrel.label} explota correctamente`);

            const explosionX = barrel.x;
            const explosionY = barrel.y;

            // Remover barril
            if (barrel.additionalElements) {
                barrel.additionalElements.forEach(element => element.destroy());
            }
            barrel.destroy();
            barrels.splice(barrelIndex, 1);

            // Crear efecto de explosi√≥n
            createExplosionEffect.call(this, explosionX, explosionY);

            explosionCount++;
            updateStatus();
        }

        function damageStructure(structure, structureIndex) {
            structure.health -= 1;
            logEvent(`üî® DA√ëO: ${structure.label} recibe da√±o (${structure.health}/${structure.maxHealth} HP)`);

            // Efecto visual de da√±o
            this.tweens.add({
                targets: structure,
                scaleX: 1.1,
                scaleY: 1.1,
                duration: 100,
                yoyo: true
            });

            if (structure.health <= 0) {
                logEvent(`üíî DESTRUIDO: ${structure.label} destruido (SIN explosi√≥n)`);
                structure.destroy();
                structures.splice(structureIndex, 1);
                updateStatus();
            }
        }

        function createExplosionEffect(x, y) {
            // Efecto visual simple de explosi√≥n
            const explosion = this.add.circle(x, y, 60, 0xff4500, 0.8);
            
            this.tweens.add({
                targets: explosion,
                scaleX: 2,
                scaleY: 2,
                alpha: 0,
                duration: 500,
                ease: 'Power2',
                onComplete: () => explosion.destroy()
            });

            // Part√≠culas
            for (let i = 0; i < 12; i++) {
                const angle = (i / 12) * Math.PI * 2;
                const particle = this.add.rectangle(
                    x + Math.cos(angle) * 20,
                    y + Math.sin(angle) * 20,
                    4, 4, 0xff6600
                );
                
                this.tweens.add({
                    targets: particle,
                    x: x + Math.cos(angle) * 80,
                    y: y + Math.sin(angle) * 80,
                    alpha: 0,
                    duration: 400,
                    onComplete: () => particle.destroy()
                });
            }

            this.cameras.main.shake(200, 0.02);
        }

        function updateStatus() {
            document.getElementById('barrels').textContent = barrels.length;
            document.getElementById('structures').textContent = structures.length;
            document.getElementById('explosions').textContent = explosionCount;
        }

        function logEvent(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Inicializar juego
        const game = new Phaser.Game(config);
    </script>
</body>
</html>