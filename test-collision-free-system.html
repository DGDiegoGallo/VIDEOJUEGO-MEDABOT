<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Sistema de Espacios Libres</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
        }
        .info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .success { color: #4CAF50; }
        .warning { color: #FF9800; }
        .error { color: #f44336; }
        .code {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
        .feature {
            background: #2d4a2d;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            border-left: 4px solid #4CAF50;
        }
    </style>
</head>
<body>
    <h1>🎯 Test del Sistema de Espacios Libres</h1>
    
    <div class="info">
        <h2>✅ Sistema Implementado</h2>
        <p>Se ha implementado un sistema completo de verificación de espacios libres para evitar que estructuras y enemigos se generen unos encima de otros.</p>
        
        <h3>🏗️ Mejoras en StructureManager:</h3>
        <div class="feature">
            <strong>isPositionFree(x, y, radius, excludeTypes?)</strong><br>
            Verifica si una posición está libre de estructuras dentro de un radio específico
        </div>
        
        <div class="feature">
            <strong>findFreePosition(targetX, targetY, minRadius, maxRadius, maxAttempts)</strong><br>
            Encuentra una posición libre cerca de una ubicación objetivo usando múltiples intentos
        </div>

        <h3>🌍 Mejoras en WorldManager:</h3>
        <div class="feature">
            <strong>isPositionFreeOfObstacles(x, y, radius, includeRivers)</strong><br>
            Verifica espacios libres considerando tanto estructuras como ríos
        </div>
        
        <div class="feature">
            <strong>findFreePositionForSpawn(targetX, targetY, ...)</strong><br>
            Encuentra posiciones libres para spawn de enemigos y objetos
        </div>

        <div class="feature">
            <strong>Generación de estructuras mejorada</strong><br>
            Las estructuras ahora se generan con separación mínima de 60px entre ellas
        </div>

        <h3>👹 Mejoras en EnemyManager:</h3>
        <div class="feature">
            <strong>setWorldManager(worldManager)</strong><br>
            Conecta el EnemyManager con WorldManager para verificación de espacios
        </div>
        
        <div class="feature">
            <strong>getRandomSpawnPosition() mejorado</strong><br>
            Ahora verifica que la posición de spawn esté libre de obstáculos antes de crear enemigos
        </div>

        <div class="feature">
            <strong>Sistema de fallback</strong><br>
            Si no se encuentra posición libre después de 20 intentos, usa posición básica con advertencia
        </div>

        <h3>🎮 Integración en MainScene:</h3>
        <div class="feature">
            <strong>Conexión automática</strong><br>
            EnemyManager se conecta automáticamente con WorldManager al inicializar
        </div>
        
        <div class="feature">
            <strong>Barriles explosivos mejorados</strong><br>
            Los barriles ahora se generan con verificación de espacios libres y separación mínima
        </div>

        <h3>🔧 Configuración del Sistema:</h3>
        <div class="code">
// Separación mínima entre estructuras
const minSeparation = 60; // píxeles

// Radio de verificación para enemigos
const enemyRadius = 25; // píxeles

// Separación mínima para barriles explosivos
const barrelSeparation = 80; // píxeles

// Máximo intentos para encontrar posición libre
const maxAttempts = 20; // intentos
        </div>

        <h3>📊 Beneficios del Sistema:</h3>
        <ul>
            <li><span class="success">✅ No más enemigos atascados</span> - Los enemigos no aparecen dentro de estructuras</li>
            <li><span class="success">✅ Estructuras bien espaciadas</span> - Separación mínima garantizada entre estructuras</li>
            <li><span class="success">✅ Respeta ríos</span> - Las verificaciones incluyen ríos como obstáculos</li>
            <li><span class="success">✅ Sistema de fallback</span> - Siempre encuentra una posición, aunque no sea perfecta</li>
            <li><span class="success">✅ Configurable</span> - Radios y separaciones fácilmente ajustables</li>
            <li><span class="success">✅ Eficiente</span> - Usa intentos limitados para evitar bucles infinitos</li>
        </ul>

        <h3>🎯 Casos de Uso Resueltos:</h3>
        <div class="code">
// 1. Generación de estructuras en chunks
for (let i = 0; i < structureCount; i++) {
  // Genera posición aleatoria
  const structX = centerX + Math.cos(angle) * distance;
  const structY = centerY + Math.sin(angle) * distance;
  
  // Verifica que no esté cerca de ríos
  if (this.isNearRiver(structX, structY, chunk)) continue;
  
  // Verifica separación mínima con otras estructuras
  if (!this.structureManager.isPositionFree(structX, structY, 60)) continue;
  
  // Crea la estructura
  this.createStructureViaManager(chunk, structX, structY, structureType);
}

// 2. Spawn de enemigos
private getRandomSpawnPosition(playerX: number, playerY: number): Position {
  for (let attempt = 0; attempt < 20; attempt++) {
    // Genera posición en borde de pantalla
    const { x, y } = this.generateBorderPosition(playerX, playerY);
    
    // Verifica que esté libre de obstáculos
    if (this.worldManager.isPositionFreeOfObstacles(x, y, 25, true)) {
      return { x, y };
    }
  }
  // Fallback si no encuentra posición libre
  return this.getFallbackPosition(playerX, playerY);
}

// 3. Barriles explosivos
private generateExplosiveBarrels(centerX: number, centerY: number, count: number): void {
  for (let attempt = 0; attempt < count * 3 && successfulBarrels < count; attempt++) {
    const freePosition = this.worldManager.findFreePositionForSpawn(
      centerX, centerY, 80, 300, 15, true
    );
    
    if (freePosition) {
      this.worldManager.createStructureAt(freePosition.x, freePosition.y, 
        StructureType.EXPLOSIVE_BARREL, { ... });
      successfulBarrels++;
    }
  }
}
        </div>

        <h3>⚠️ Consideraciones Importantes:</h3>
        <ul>
            <li><span class="warning">🔄 Intentos limitados</span> - El sistema usa máximo 20-30 intentos para evitar bucles infinitos</li>
            <li><span class="warning">📏 Radios configurables</span> - Los radios de verificación pueden ajustarse según necesidades</li>
            <li><span class="warning">🌊 Ríos especiales</span> - Los ríos requieren tratamiento especial por su forma compleja</li>
            <li><span class="warning">🎯 Fallback necesario</span> - Siempre debe haber un plan B si no se encuentra posición libre</li>
        </ul>

        <div class="success">
            <h3>✅ Sistema Completamente Funcional</h3>
            <p>El sistema de espacios libres está implementado y funcionando. Los enemigos ya no aparecerán 
            dentro de estructuras y las estructuras mantendrán una separación mínima entre ellas.</p>
            
            <p><strong>Próximo paso sugerido:</strong> Implementar el mismo sistema para los ríos, 
            creando un RiverManager similar al StructureManager para mejor organización y control.</p>
        </div>
    </div>

    <script>
        console.log('🎯 Sistema de Espacios Libres Implementado');
        console.log('✅ StructureManager - Verificación de posiciones libres');
        console.log('✅ WorldManager - Integración con ríos y obstáculos');
        console.log('✅ EnemyManager - Spawn sin colisiones');
        console.log('✅ MainScene - Conexiones automáticas');
        console.log('🚀 Enemigos y estructuras ahora respetan espacios libres');
    </script>
</body>
</html>