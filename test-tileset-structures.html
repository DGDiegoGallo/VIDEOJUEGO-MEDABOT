<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Estructuras del Tileset</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #2c3e50;
            color: white;
            font-family: Arial, sans-serif;
        }
        #game-container {
            border: 2px solid #34495e;
            margin: 20px auto;
            display: block;
        }
        .info {
            text-align: center;
            margin: 10px 0;
        }
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #2980b9;
        }
    </style>
</head>
<body>
    <div class="info">
        <h1>üèóÔ∏è Test - Estructuras del Tileset</h1>
        <p>Prueba de las nuevas estructuras del tileset con colisiones rectangulares</p>
    </div>

    <div class="controls">
        <button onclick="testScene.createRandomStructures()">Crear Estructuras Aleatorias</button>
        <button onclick="testScene.createAllStructureTypes()">Crear Todos los Tipos</button>
        <button onclick="testScene.clearStructures()">Limpiar Estructuras</button>
        <button onclick="testScene.createBarrel()">Crear Barril Explosivo</button>
    </div>

    <div id="game-container"></div>

    <div class="info">
        <p><strong>Controles:</strong></p>
        <p>‚Ä¢ Flechas: Mover jugador</p>
        <p>‚Ä¢ Espacio: Disparar</p>
        <p>‚Ä¢ Los botones crean diferentes tipos de estructuras</p>
    </div>

    <script type="module">
        // Importar tipos de estructura
        const StructureType = {
            BONES_SMALL: 'bones_small',
            BONES_LARGE: 'bones_large',
            BROKEN_TREE_LARGE: 'broken_tree_large',
            BROKEN_TREE_SMALL: 'broken_tree_small',
            BROKEN_TREE_MEDIUM: 'broken_tree_medium',
            BROKEN_TREE_STUMP_1: 'broken_tree_stump_1',
            BROKEN_TREE_STUMP_2: 'broken_tree_stump_2',
            BROKEN_TREE_STUMP_3: 'broken_tree_stump_3',
            DEAD_ARM_1: 'dead_arm_1',
            DEAD_ARM_2: 'dead_arm_2',
            DEAD_ARM_3: 'dead_arm_3',
            DEAD_ARM_4: 'dead_arm_4',
            PILE_SKULLS: 'pile_skulls',
            PLANT_LARGE: 'plant_large',
            PLANT_SMALL: 'plant_small',
            ROCK_LARGE: 'rock_large',
            ROCK_MEDIUM: 'rock_medium',
            THORN_PLANT_1: 'thorn_plant_1',
            THORN_PLANT_2: 'thorn_plant_2',
            TREE_SMALL: 'tree_small',
            TREE_LARGE: 'tree_large',
            EXPLOSIVE_BARREL: 'explosive_barrel'
        };

        // Datos del tileset
        const TILESET_DATA = {
            [StructureType.BONES_SMALL]: { image: 'Bones_shadow1_3.png', imageSize: { width: 32, height: 32 }, collision: { x: 3, y: 5, width: 25, height: 22 } },
            [StructureType.BONES_LARGE]: { image: 'Bones_shadow2_6.png', imageSize: { width: 64, height: 64 }, collision: { x: 8, y: 8, width: 48, height: 48 } },
            [StructureType.BROKEN_TREE_LARGE]: { image: 'Broken_ tree_shadow3_1.png', imageSize: { width: 128, height: 128 }, collision: { x: 22, y: 52.9, width: 84, height: 30.1 } },
            [StructureType.BROKEN_TREE_SMALL]: { image: 'Broken_tree_shadow1_2.png', imageSize: { width: 32, height: 32 }, collision: { x: 9.2, y: 6.8, width: 18.2, height: 24.4 } },
            [StructureType.BROKEN_TREE_MEDIUM]: { image: 'Broken_tree_shadow1_4.png', imageSize: { width: 64, height: 64 }, collision: { x: 11.9, y: 15.5, width: 39, height: 29.9 } },
            [StructureType.BROKEN_TREE_STUMP_1]: { image: 'Broken_tree_shadow2_1-1.png', imageSize: { width: 128, height: 128 }, collision: { x: 57.3, y: 74.5, width: 33.7, height: 33.5 } },
            [StructureType.BROKEN_TREE_STUMP_2]: { image: 'Broken_tree_shadow2_2-1.png', imageSize: { width: 128, height: 128 }, collision: { x: 43.3, y: 58.3, width: 30.3, height: 39.8 } },
            [StructureType.BROKEN_TREE_STUMP_3]: { image: 'Broken_tree_shadow2_3-1.png', imageSize: { width: 64, height: 64 }, collision: { x: 21, y: 20.6, width: 34, height: 27.4 } },
            [StructureType.DEAD_ARM_1]: { image: 'Dead_arm_shadow1_1.png', imageSize: { width: 64, height: 64 }, collision: { x: 24.8, y: 14.6, width: 37.2, height: 39.5 } },
            [StructureType.DEAD_ARM_2]: { image: 'Dead_arm_shadow1_2.png', imageSize: { width: 64, height: 64 }, collision: { x: 16.5, y: 23.2, width: 25.7, height: 28.8 } },
            [StructureType.DEAD_ARM_3]: { image: 'Dead_arm_shadow1_3.png', imageSize: { width: 64, height: 64 }, collision: { x: 23.6, y: 25.2, width: 17, height: 25.5 } },
            [StructureType.DEAD_ARM_4]: { image: 'Dead_arm_shadow1_4.png', imageSize: { width: 64, height: 64 }, collision: { x: 20.7, y: 25.8, width: 19.3, height: 20.1 } },
            [StructureType.PILE_SKULLS]: { image: 'Pile_sculls_shadow1.png', imageSize: { width: 128, height: 128 }, collision: { x: 34.4, y: 52.4, width: 59.7, height: 36.6 } },
            [StructureType.PLANT_LARGE]: { image: 'Plant_shadow1_1.png', imageSize: { width: 128, height: 128 }, collision: { x: 32, y: 53.5, width: 64, height: 39.5 } },
            [StructureType.PLANT_SMALL]: { image: 'Plant_shadow1_2.png', imageSize: { width: 64, height: 64 }, collision: { x: 11, y: 26.1, width: 42, height: 23.9 } },
            [StructureType.ROCK_LARGE]: { image: 'Rock_shadow1_1.png', imageSize: { width: 64, height: 64 }, collision: { x: 3, y: 8.5, width: 57, height: 51.5 } },
            [StructureType.ROCK_MEDIUM]: { image: 'Rock_shadow1_2.png', imageSize: { width: 64, height: 64 }, collision: { x: 9, y: 10, width: 45, height: 44 } },
            [StructureType.THORN_PLANT_1]: { image: 'Thorn_plant_shadow1_1.png', imageSize: { width: 128, height: 128 }, collision: { x: 68.5, y: 69.8, width: 19.8, height: 18.5 } },
            [StructureType.THORN_PLANT_2]: { image: 'Thorn_plant_shadow1_2.png', imageSize: { width: 128, height: 128 }, collision: { x: 17, y: 65.7, width: 25.6, height: 24.3 } },
            [StructureType.TREE_SMALL]: { image: 'Tree_shadow1_2.png', imageSize: { width: 64, height: 64 }, collision: { x: 17.5, y: 36.2, width: 28.6, height: 26.8 } },
            [StructureType.TREE_LARGE]: { image: 'Tree_shadow2_1.png', imageSize: { width: 128, height: 128 }, collision: { x: 44.2, y: 70.6, width: 34.6, height: 30.4 } }
        };

        class TestScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestScene' });
                this.structures = [];
                this.player = null;
                this.cursors = null;
                this.bullets = [];
            }

            preload() {
                // Cargar todas las im√°genes del tileset
                Object.entries(TILESET_DATA).forEach(([type, data]) => {
                    this.load.image(`structure_${type}`, `src/assets/objects/${data.image}`);
                });
            }

            create() {
                // Crear jugador simple
                this.player = this.add.rectangle(400, 300, 20, 20, 0x3498db);
                this.physics.add.existing(this.player);
                this.player.body.setCollideWorldBounds(true);

                // Configurar controles
                this.cursors = this.input.keyboard.createCursorKeys();
                this.spaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

                // Crear grupo de estructuras para colisiones
                this.structureGroup = this.physics.add.staticGroup();

                // Configurar colisiones
                this.physics.add.collider(this.player, this.structureGroup);

                console.log('üéÆ Escena de prueba iniciada - Estructuras del tileset cargadas');
        
        // Agregar texto de informaci√≥n
        this.add.text(10, 10, 'Colisiones VERDES = Datos del JSON del tileset', {
            fontSize: '16px',
            color: '#00ff00',
            backgroundColor: '#000000',
            padding: { x: 5, y: 5 }
        });
            }

            update() {
                // Movimiento del jugador
                if (this.cursors.left.isDown) {
                    this.player.body.setVelocityX(-200);
                } else if (this.cursors.right.isDown) {
                    this.player.body.setVelocityX(200);
                } else {
                    this.player.body.setVelocityX(0);
                }

                if (this.cursors.up.isDown) {
                    this.player.body.setVelocityY(-200);
                } else if (this.cursors.down.isDown) {
                    this.player.body.setVelocityY(200);
                } else {
                    this.player.body.setVelocityY(0);
                }

                // Disparar
                if (Phaser.Input.Keyboard.JustDown(this.spaceKey)) {
                    this.shoot();
                }

                // Actualizar balas
                this.bullets.forEach((bullet, index) => {
                    if (bullet.x < 0 || bullet.x > 800 || bullet.y < 0 || bullet.y > 600) {
                        bullet.destroy();
                        this.bullets.splice(index, 1);
                    }
                });
            }

            shoot() {
                const bullet = this.add.rectangle(this.player.x, this.player.y, 4, 4, 0xe74c3c);
                this.physics.add.existing(bullet);
                bullet.body.setVelocity(0, -300);
                this.bullets.push(bullet);

                // Colisi√≥n con estructuras
                this.physics.add.overlap(bullet, this.structureGroup, (bullet, structure) => {
                    bullet.destroy();
                    const index = this.bullets.indexOf(bullet);
                    if (index > -1) this.bullets.splice(index, 1);
                    
                    console.log(`üí• Bala impact√≥ estructura: ${structure.structureType}`);
                });
            }

            createStructure(type, x, y) {
                const data = TILESET_DATA[type];
                if (!data) {
                    console.warn(`Tipo de estructura no encontrado: ${type}`);
                    return;
                }

                // Crear contenedor
                const container = this.add.container(x, y);

                // Crear sprite principal
                const mainSprite = this.add.image(0, 0, `structure_${type}`);
                mainSprite.setOrigin(0.5, 0.5);
                container.add(mainSprite);

                // Crear sprite de colisi√≥n basado en los datos exactos del JSON
                const collision = data.collision;
                const imageSize = data.imageSize;
                
                const collisionX = collision.x - imageSize.width / 2 + collision.width / 2;
                const collisionY = collision.y - imageSize.height / 2 + collision.height / 2;
                
                const collisionSprite = this.add.rectangle(
                    collisionX, collisionY,
                    collision.width, collision.height,
                    0x00ff00, 0.2 // Verde semi-transparente para mostrar colisiones del JSON
                );
                container.add(collisionSprite);

                // Agregar f√≠sica solo al sprite de colisi√≥n
                this.physics.add.existing(collisionSprite, true);
                this.structureGroup.add(collisionSprite);

                // Guardar tipo para debug
                collisionSprite.structureType = type;
                container.structureType = type;

                this.structures.push(container);
                console.log(`üèóÔ∏è Estructura creada: ${type} en (${x}, ${y})`);

                return container;
            }

            createRandomStructures() {
                const types = Object.keys(TILESET_DATA);
                
                for (let i = 0; i < 10; i++) {
                    const randomType = types[Math.floor(Math.random() * types.length)];
                    const x = 100 + Math.random() * 600;
                    const y = 100 + Math.random() * 400;
                    
                    this.createStructure(randomType, x, y);
                }
                
                console.log('üé≤ 10 estructuras aleatorias creadas');
            }

            createAllStructureTypes() {
                const types = Object.keys(TILESET_DATA);
                const cols = 5;
                const startX = 100;
                const startY = 100;
                const spacingX = 120;
                const spacingY = 100;

                types.forEach((type, index) => {
                    const col = index % cols;
                    const row = Math.floor(index / cols);
                    const x = startX + col * spacingX;
                    const y = startY + row * spacingY;
                    
                    this.createStructure(type, x, y);
                });

                console.log(`üèóÔ∏è Todos los tipos de estructura creados (${types.length} tipos)`);
            }

            createBarrel() {
                // Crear barril explosivo con la implementaci√≥n original
                const x = 200 + Math.random() * 400;
                const y = 200 + Math.random() * 200;
                
                const barrel = this.add.rectangle(x, y, 24, 24, 0x8b4513);
                barrel.setStrokeStyle(3, 0x654321);
                
                // Agregar f√≠sica
                this.physics.add.existing(barrel, true);
                this.structureGroup.add(barrel);
                barrel.structureType = StructureType.EXPLOSIVE_BARREL;
                
                this.structures.push(barrel);
                console.log('üí• Barril explosivo creado');
            }

            clearStructures() {
                this.structures.forEach(structure => {
                    if (structure.destroy) {
                        structure.destroy();
                    }
                });
                this.structures = [];
                this.structureGroup.clear(true, true);
                console.log('üßπ Todas las estructuras eliminadas');
            }
        }

        // Configuraci√≥n del juego
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#34495e',
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: TestScene
        };

        // Inicializar juego
        const game = new Phaser.Game(config);
        window.testScene = game.scene.scenes[0];

        console.log('üéÆ Juego de prueba iniciado - Estructuras del tileset');
    </script>
</body>
</html>