<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Detección de Misiones Completadas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #45a049;
        }
        .button.danger {
            background: #f44336;
        }
        .button.danger:hover {
            background: #da190b;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .quest-info {
            background: #333;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .completed {
            border-left: 4px solid #4CAF50;
        }
        .pending {
            border-left: 4px solid #ff9800;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 Test - Detección de Misiones Completadas</h1>
        
        <div class="test-section">
            <h2>📋 Estado Actual de Misiones</h2>
            <div id="questStatus">Cargando...</div>
        </div>

        <div class="test-section">
            <h2>🎯 Acciones de Debug</h2>
            <button class="button" onclick="loadQuestsFromStorage()">📥 Cargar Misiones desde localStorage</button>
            <button class="button" onclick="generateNewQuests()">🎲 Generar Nuevas Misiones</button>
            <button class="button" onclick="forceCheckProgress()">🔧 Forzar Verificación de Progreso</button>
            <button class="button" onclick="simulateProgress()">⚡ Simular Progreso</button>
            <button class="button danger" onclick="clearStorage()">🗑️ Limpiar localStorage</button>
        </div>

        <div class="test-section">
            <h2>📊 Progreso Actual</h2>
            <div id="progressInfo">Cargando...</div>
        </div>

        <div class="test-section">
            <h2>📝 Log de Debug</h2>
            <div id="debugLog" class="log"></div>
        </div>
    </div>

    <script>
        // Simular el DailyQuestManager
        class MockDailyQuestManager {
            constructor(userId) {
                this.userId = userId;
                this.dailyQuests = [];
                this.questProgress = {
                    enemiesKilled: 0,
                    zombiesKilled: 0,
                    dashersKilled: 0,
                    tanksKilled: 0,
                    currentLevel: 1,
                    survivalTime: 0,
                    supplyBoxesCollected: 0,
                    barrelsDestroyed: 0,
                    bandagesUsed: 0,
                    levelsGained: 0
                };
            }

            getStoredQuests() {
                const storageKey = `dailyQuests_${this.userId}`;
                const stored = localStorage.getItem(storageKey);
                
                if (stored) {
                    try {
                        return JSON.parse(stored);
                    } catch (error) {
                        console.error('Error parsing stored quests:', error);
                    }
                }
                
                return { date: '', userId: this.userId, quests: [] };
            }

            generateDailyQuests() {
                const questTemplates = [
                    {
                        type: 'kill_enemies',
                        titles: ['Exterminador', 'Cazador de Enemigos'],
                        descriptions: ['Elimina {target} enemigos'],
                        targets: [1, 2],
                        rewards: [1, 2]
                    },
                    {
                        type: 'kill_zombies',
                        titles: ['Cazador de Zombies', 'Exterminador de No-Muertos'],
                        descriptions: ['Elimina {target} zombies'],
                        targets: [1, 2],
                        rewards: [1, 2]
                    },
                    {
                        type: 'survive_time',
                        titles: ['Superviviente', 'Resistente'],
                        descriptions: ['Sobrevive {target} segundos'],
                        targets: [5, 10],
                        rewards: [1, 2]
                    }
                ];

                const selectedTemplates = this.shuffleArray([...questTemplates]).slice(0, 3);
                
                this.dailyQuests = selectedTemplates.map((template, index) => {
                    const titleIndex = Math.floor(Math.random() * template.titles.length);
                    const descIndex = Math.floor(Math.random() * template.descriptions.length);
                    const targetIndex = Math.floor(Math.random() * template.targets.length);
                    const rewardIndex = Math.floor(Math.random() * template.rewards.length);

                    return {
                        id: `quest_${index + 1}`,
                        title: template.titles[titleIndex],
                        description: template.descriptions[descIndex].replace('{target}', template.targets[targetIndex].toString()),
                        type: template.type,
                        target: template.targets[targetIndex],
                        progress: 0,
                        reward: template.rewards[rewardIndex],
                        completed: false
                    };
                });

                this.saveQuests();
                log('🎲 Misiones generadas:', this.dailyQuests);
            }

            saveQuests() {
                const questData = {
                    date: new Date().toDateString(),
                    userId: this.userId,
                    quests: this.dailyQuests
                };
                
                localStorage.setItem(`dailyQuests_${this.userId}`, JSON.stringify(questData));
            }

            getQuestProgress() {
                return this.questProgress;
            }

            getCompletedQuests() {
                return this.dailyQuests.filter(quest => quest.completed);
            }

            getDailyQuests() {
                return this.dailyQuests;
            }

            forceCheckProgress() {
                log('🔧 Forzando verificación de progreso...');
                
                for (const quest of this.dailyQuests) {
                    if (quest.completed) continue;
                    
                    let currentProgress = 0;
                    
                    switch (quest.type) {
                        case 'kill_enemies':
                            currentProgress = this.questProgress.enemiesKilled;
                            break;
                        case 'kill_zombies':
                            currentProgress = this.questProgress.zombiesKilled;
                            break;
                        case 'survive_time':
                            currentProgress = Math.floor(this.questProgress.survivalTime);
                            break;
                    }
                    
                    quest.progress = currentProgress;
                    
                    if (quest.progress >= quest.target && !quest.completed) {
                        quest.completed = true;
                        quest.completedAt = new Date().toISOString();
                        log(`🎯 Misión completada: ${quest.title} - Progreso: ${quest.progress}/${quest.target}`);
                    }
                }
                
                this.saveQuests();
                log('🔧 Verificación completada');
            }

            shuffleArray(array) {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            }
        }

        // Variables globales
        const userId = 82; // Usar el mismo userId que en la imagen
        const questManager = new MockDailyQuestManager(userId);

        // Funciones de debug
        function log(message, data = null) {
            const logElement = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}${data ? '\n' + JSON.stringify(data, null, 2) : ''}\n`;
            logElement.textContent += logEntry;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message, data);
        }

        function updateQuestStatus() {
            const questStatus = document.getElementById('questStatus');
            const storedQuests = questManager.getStoredQuests();
            
            if (storedQuests.quests.length === 0) {
                questStatus.innerHTML = '<p>❌ No hay misiones en localStorage</p>';
                return;
            }

            let html = '<h3>📋 Misiones Actuales:</h3>';
            storedQuests.quests.forEach((quest, index) => {
                const statusClass = quest.completed ? 'completed' : 'pending';
                const statusIcon = quest.completed ? '✅' : '⏳';
                html += `
                    <div class="quest-info ${statusClass}">
                        <h4>${statusIcon} ${quest.title}</h4>
                        <p><strong>Tipo:</strong> ${quest.type}</p>
                        <p><strong>Descripción:</strong> ${quest.description}</p>
                        <p><strong>Progreso:</strong> ${quest.progress}/${quest.target}</p>
                        <p><strong>Recompensa:</strong> ${quest.reward} alimentos</p>
                        <p><strong>Estado:</strong> ${quest.completed ? 'Completada' : 'Pendiente'}</p>
                        ${quest.completedAt ? `<p><strong>Completada en:</strong> ${new Date(quest.completedAt).toLocaleString()}</p>` : ''}
                    </div>
                `;
            });

            questStatus.innerHTML = html;
        }

        function updateProgressInfo() {
            const progressInfo = document.getElementById('progressInfo');
            const progress = questManager.getQuestProgress();
            
            progressInfo.innerHTML = `
                <h3>📊 Progreso Actual:</h3>
                <p><strong>Enemigos eliminados:</strong> ${progress.enemiesKilled}</p>
                <p><strong>Zombies eliminados:</strong> ${progress.zombiesKilled}</p>
                <p><strong>Dashers eliminados:</strong> ${progress.dashersKilled}</p>
                <p><strong>Tanques eliminados:</strong> ${progress.tanksKilled}</p>
                <p><strong>Nivel actual:</strong> ${progress.currentLevel}</p>
                <p><strong>Tiempo de supervivencia:</strong> ${Math.floor(progress.survivalTime)}s</p>
                <p><strong>Cajas recolectadas:</strong> ${progress.supplyBoxesCollected}</p>
                <p><strong>Barriles destruidos:</strong> ${progress.barrelsDestroyed}</p>
                <p><strong>Vendajes usados:</strong> ${progress.bandagesUsed}</p>
                <p><strong>Niveles ganados:</strong> ${progress.levelsGained}</p>
            `;
        }

        // Funciones de acción
        function loadQuestsFromStorage() {
            log('📥 Cargando misiones desde localStorage...');
            const storedQuests = questManager.getStoredQuests();
            log('📥 Misiones encontradas:', storedQuests);
            
            if (storedQuests.quests.length > 0) {
                questManager.dailyQuests = storedQuests.quests;
                log('✅ Misiones cargadas correctamente');
            } else {
                log('❌ No se encontraron misiones');
            }
            
            updateQuestStatus();
        }

        function generateNewQuests() {
            log('🎲 Generando nuevas misiones...');
            questManager.generateDailyQuests();
            updateQuestStatus();
        }

        function forceCheckProgress() {
            log('🔧 Forzando verificación de progreso...');
            questManager.forceCheckProgress();
            updateQuestStatus();
            
            const completedQuests = questManager.getCompletedQuests();
            log(`🎯 Misiones completadas encontradas: ${completedQuests.length}`, completedQuests);
        }

        function simulateProgress() {
            log('⚡ Simulando progreso...');
            
            // Simular progreso aleatorio
            questManager.questProgress.enemiesKilled += Math.floor(Math.random() * 3) + 1;
            questManager.questProgress.zombiesKilled += Math.floor(Math.random() * 2) + 1;
            questManager.questProgress.survivalTime += Math.floor(Math.random() * 10) + 5;
            
            log('⚡ Progreso simulado:', questManager.questProgress);
            updateProgressInfo();
            
            // Verificar progreso automáticamente
            forceCheckProgress();
        }

        function clearStorage() {
            log('🗑️ Limpiando localStorage...');
            localStorage.removeItem(`dailyQuests_${userId}`);
            localStorage.removeItem(`questProgress_${userId}`);
            questManager.dailyQuests = [];
            log('✅ localStorage limpiado');
            updateQuestStatus();
            updateProgressInfo();
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 Iniciando test de detección de misiones...');
            log(`👤 UserId: ${userId}`);
            
            // Cargar estado inicial
            loadQuestsFromStorage();
            updateProgressInfo();
            
            // Cargar progreso guardado
            const storedProgress = localStorage.getItem(`questProgress_${userId}`);
            if (storedProgress) {
                try {
                    questManager.questProgress = JSON.parse(storedProgress);
                    log('📊 Progreso cargado desde localStorage:', questManager.questProgress);
                } catch (error) {
                    log('❌ Error cargando progreso:', error);
                }
            }
            
            updateProgressInfo();
        });
    </script>
</body>
</html> 